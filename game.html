<!DOCTYPE html>
<html lang="uz">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Saad English Mini Game</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --bg: #030712;
            --surface: #111827;
            --surface-light: #1f2937;
            --primary: #8b5cf6;
            --primary-glow: rgba(139, 92, 246, 0.4);
            --secondary: #10b981;
            --accent: #f59e0b;
            --text: #f9fafb;
            --text-dim: #9ca3af;
            --card-border: rgba(255, 255, 255, 0.08);
            --gradient: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
        }

        /* Glassmorphism Navigation */
        .bottom-nav {
            background: rgba(3, 7, 18, 0.8);
            backdrop-filter: blur(20px);
            border-top: 1px solid var(--card-border);
            padding: 12px 20px 24px;
            display: flex;
            justify-content: space-around;
            position: fixed;
            bottom: 0;
            width: 100%;
            z-index: 100;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--text-dim);
            font-size: 11px;
            font-weight: 500;
            gap: 4px;
            transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            width: 60px;
        }

        .nav-item.active {
            color: var(--primary);
            transform: translateY(-4px);
        }

        .nav-item i {
            width: 24px;
            height: 24px;
        }

        .nav-item.active i {
            filter: drop-shadow(0 0 8px var(--primary-glow));
        }

        /* Screens */
        .screens-container {
            flex: 1;
            overflow-y: auto;
            padding: 24px 20px 100px;
        }

        .screen {
            display: none;
            animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .screen.active {
            display: block;
        }

        /* Dashboard Header */
        .header {
            margin-bottom: 32px;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }

        .header-title h2 {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-dim);
            margin-bottom: 4px;
        }

        .header-title h1 {
            font-size: 28px;
            font-weight: 800;
            letter-spacing: -0.5px;
            background: var(--gradient);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .user-rank {
            background: var(--surface-light);
            padding: 6px 12px;
            border-radius: 99px;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            font-weight: 600;
            border: 1px solid var(--card-border);
        }

        /* Premium Cards */
        .card {
            background: var(--surface);
            border: 1px solid var(--card-border);
            border-radius: 24px;
            padding: 24px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
            transition: 0.3s ease;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.03), transparent);
            pointer-events: none;
        }

        .card:active {
            transform: scale(0.98);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 32px;
        }

        .stat-box {
            background: var(--surface-light);
            border: 1px solid var(--card-border);
            border-radius: 20px;
            padding: 16px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 800;
            margin-bottom: 4px;
            color: white;
        }

        .stat-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Game UI */
        .game-area {
            min-height: 420px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        .word-crystal {
            font-size: 32px;
            font-weight: 800;
            margin-bottom: 40px;
            padding: 20px 40px;
            background: rgba(139, 92, 246, 0.1);
            border: 2px solid var(--primary);
            border-radius: 30px;
            box-shadow: 0 0 30px var(--primary-glow);
            animation: float 3s ease-in-out infinite;
        }

        .options-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            width: 100%;
        }

        .btn-option {
            background: var(--surface-light);
            border: 1px solid var(--card-border);
            padding: 18px;
            border-radius: 20px;
            font-size: 16px;
            font-weight: 600;
            color: var(--text);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            text-align: left;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .btn-option:active {
            background: var(--primary);
            color: white;
        }

        .btn-option.correct {
            background: var(--secondary) !important;
            border-color: #059669;
            color: white;
        }

        .btn-option.wrong {
            background: #ef4444 !important;
            border-color: #b91c1c;
            color: white;
        }

        /* Big Button */
        .btn-action {
            background: var(--gradient);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 20px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 8px 16px rgba(139, 92, 246, 0.3);
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        /* Quests */
        .quest-item {
            display: flex;
            gap: 16px;
            padding: 16px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 16px;
            margin-bottom: 12px;
        }

        .quest-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: rgba(139, 92, 246, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
        }

        .quest-info h4 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .quest-info p {
            font-size: 12px;
            color: var(--text-dim);
        }

        /* Progress Bar */
        .progress-bar-container {
            height: 8px;
            background: var(--surface-light);
            border-radius: 4px;
            margin-top: 12px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--gradient);
            width: 0%;
            transition: width 1s ease;
        }

        /* Animations */
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes celebrate {
            0% { transform: scale(1) rotate(0deg); }
            25% { transform: scale(1.1) rotate(-5deg); }
            50% { transform: scale(1.2) rotate(5deg); }
            75% { transform: scale(1.1) rotate(-5deg); }
            100% { transform: scale(1) rotate(0deg); }
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-5px);
            }

            75% {
                transform: translateX(5px);
            }
        }

        @keyframes scorePopup {
            0% { opacity: 0; transform: translateY(20px) scale(0.5); }
            50% { opacity: 1; transform: translateY(-10px) scale(1.2); }
            100% { opacity: 0; transform: translateY(-30px) scale(1); }
        }

        .score-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 48px;
            font-weight: 800;
            color: var(--secondary);
            text-shadow: 0 0 20px var(--secondary);
            pointer-events: none;
            z-index: 2000;
            animation: scorePopup 1s ease-out forwards;
        }

        .combo-display {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 64px;
            font-weight: 800;
            color: var(--accent);
            text-shadow: 0 0 30px var(--accent);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .combo-display.active {
            opacity: 1;
            animation: pulse 0.5s ease-in-out;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--surface);
            border: 1px solid var(--card-border);
            border-radius: 24px;
            padding: 24px;
            width: 100%;
            max-width: 320px;
            animation: slideUp 0.3s ease;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 20px;
            text-align: center;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            font-size: 12px;
            color: var(--text-dim);
            margin-bottom: 8px;
            font-weight: 600;
        }

        .modal-input {
            width: 100%;
            background: var(--surface-light);
            border: 1px solid var(--card-border);
            border-radius: 12px;
            padding: 12px 16px;
            color: var(--text);
            font-family: inherit;
            font-size: 14px;
            outline: none;
        }

        .modal-input:focus {
            border-color: var(--primary);
        }

        .modal-actions {
            display: flex;
            gap: 12px;
        }

        .btn-modal {
            flex: 1;
            padding: 12px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            border: none;
        }

        .btn-save {
            background: var(--gradient);
            color: white;
        }

        .btn-cancel {
            background: var(--surface-light);
            color: var(--text);
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-5px);
            }

            75% {
                transform: translateX(5px);
            }
        }
    </style>
</head>

<body>

    <div class="screens-container">

        <!-- DASHBOARD -->
        <div id="screen-home" class="screen active">
            <div class="header">
                <div class="header-title">
                    <h2>Xush kelibsiz! üëã</h2>
                    <h1>English Universe</h1>
                </div>
                <div class="user-rank">
                    <i data-lucide="award" style="width:14px; height:14px; color:var(--accent);"></i>
                    <span>LEGENDARY</span>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-box">
                    <div class="stat-value" id="xp-counter">1,240</div>
                    <div class="stat-label">Tajriba (XP)</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="streak-counter">12</div>
                    <div class="stat-label">Kunlik Streak</div>
                </div>
            </div>

            <div class="card" style="background: linear-gradient(rgba(139,92,246,0.1), transparent), var(--surface);">
                <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:16px;">
                    <div>
                        <h3 style="font-size:18px; font-weight:700; margin-bottom:4px;">Kunlik Missiya</h3>
                        <p style="font-size:13px; color:var(--text-dim);">Darslarni tugatib XP oling</p>
                    </div>
                    <i data-lucide="target" style="color:var(--primary);"></i>
                </div>
                <div class="quest-item" style="background:transparent; padding:0; margin-bottom:0;">
                    <div class="quest-info" style="width:100%;">
                        <div style="display:flex; justify-content:space-between; font-size:12px; font-weight:600;">
                            <span>Progress</span>
                            <span>7/10 ta dars</span>
                        </div>
                        <div class="progress-bar-container">
                            <div class="progress-fill" style="width: 70%;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <h3 style="font-size:16px; font-weight:700; margin:24px 0 16px;">üî• Tezkor O'yinlar</h3>
            <div class="card" onclick="switchNav('game')"
                style="display:flex; align-items:center; gap:20px; cursor:pointer;">
                <div class="quest-icon" style="width:60px; height:60px; background:var(--primary-glow);">
                    <i data-lucide="zap" style="width:32px; height:32px;"></i>
                </div>
                <div style="flex:1;">
                    <h4 style="font-weight:700; font-size:16px;">Vocabulary Battle</h4>
                    <p style="color:var(--text-dim); font-size:13px;">So'zlarni moslang va XP yuting</p>
                </div>
                <i data-lucide="chevron-right"></i>
            </div>
        </div>

        <!-- GAME SCREEN -->
        <div id="screen-game" class="screen">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                <h2 style="font-size:24px; font-weight:800;">Vocab Battle</h2>
                <div id="game-xp" style="font-weight:700; color:var(--accent);">+0 XP</div>
            </div>

            <!-- Game Stats Bar -->
            <div style="display:flex; gap:16px; margin-bottom:16px;">
                <div class="stat-box" style="flex:1;">
                    <div class="stat-value" id="game-streak" style="color:var(--accent);">0</div>
                    <div class="stat-label">üî• Streak</div>
                </div>
                <div class="stat-box" style="flex:1;">
                    <div class="stat-value" id="game-combo" style="color:var(--secondary);">x1</div>
                    <div class="stat-label">‚ö° Combo</div>
                </div>
                <div class="stat-box" style="flex:1;">
                    <div class="stat-value" id="game-score">0</div>
                    <div class="stat-label">üéØ Score</div>
                </div>
            </div>

            <!-- Mode Selection -->
            <div id="game-modes" style="margin-bottom:16px;">
                <p style="font-size:12px; color:var(--text-dim); margin-bottom:8px;">O'YIN REJIMI:</p>
                <div style="display:flex; gap:8px;">
                    <button class="btn-option active" id="mode-classic" onclick="selectMode('classic')" style="flex:1; text-align:center;">üéØ Classic</button>
                    <button class="btn-option" id="mode-speed" onclick="selectMode('speed')" style="flex:1; text-align:center;">‚ö° Speed</button>
                    <button class="btn-option" id="mode-flash" onclick="selectMode('flash')" style="flex:1; text-align:center;">‚ö° Flash</button>
                </div>
            </div>

            <!-- Difficulty Selection -->
            <div id="game-difficulty" style="margin-bottom:16px;">
                <p style="font-size:12px; color:var(--text-dim); margin-bottom:8px;">QIYINCHILIK:</p>
                <div style="display:flex; gap:8px;">
                    <button class="btn-option active" id="diff-easy" onclick="selectDifficulty('easy')" style="flex:1; text-align:center; color:var(--secondary);">üü¢ Oson</button>
                    <button class="btn-option" id="diff-medium" onclick="selectDifficulty('medium')" style="flex:1; text-align:center; color:var(--accent);">üü° O'rtacha</button>
                    <button class="btn-option" id="diff-hard" onclick="selectDifficulty('hard')" style="flex:1; text-align:center; color:#ef4444;">üî¥ Qiyin</button>
                </div>
            </div>

            <div id="game-lobby">
                <div class="card game-area">
                    <div style="font-size:64px; margin-bottom:24px;">üõ°Ô∏è</div>
                    <h3 style="font-size:20px; font-weight:700; margin-bottom:8px;">Tayyormisiz?</h3>
                    <p style="color:var(--text-dim); margin-bottom:32px;"><span id="mode-desc">To'g'ri javobni tanlang!</span></p>
                    <button class="btn-action" onclick="startGame()">üöÄ BOSHLASH</button>
                </div>
            </div>

            <div id="game-play" style="display:none;">
                <div class="word-crystal" id="current-word">CHALLENGE</div>
                <div class="combo-display" id="combo-display">x2 COMBO!</div>
                <div class="options-grid" id="game-options">
                    <!-- Options injected here -->
                </div>
                <div style="margin-top:24px; display:flex; justify-content:space-between; color:var(--text-dim); font-weight:600;">
                    <span>üí¨ <span id="question-num">1/10</span></span>
                    <span>‚è±Ô∏è <span id="game-timer" style="color:white;">60</span>s</span>
                </div>
            </div>

            <!-- End Game Screen -->
            <div id="game-end" style="display:none;">
                <div class="card" style="text-align:center; padding:32px;">
                    <div style="font-size:64px; margin-bottom:16px;">üéâ</div>
                    <h2 style="font-size:28px; font-weight:800; margin-bottom:8px;">Ajoyib!</h2>
                    <p style="color:var(--text-dim); margin-bottom:24px;">O'yin yakunlandi!</p>
                    
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:16px; margin-bottom:24px;">
                        <div class="stat-box">
                            <div class="stat-value" id="end-score" style="color:var(--accent);">0</div>
                            <div class="stat-label">üí∞ XP</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="end-accuracy" style="color:var(--secondary);">0%</div>
                            <div class="stat-label">üéØ Aniqlik</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="end-streak" style="color:var(--primary);">0</div>
                            <div class="stat-label">üî• Max Streak</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="end-level" style="color:#f59e0b;">-</div>
                            <div class="stat-label">üèÜ Level</div>
                        </div>
                    </div>
                    
                    <div id="achievement-unlock" style="display:none; margin-bottom:24px; padding:16px; background:linear-gradient(135deg, rgba(139,92,246,0.2), rgba(99,102,241,0.2)); border-radius:16px; border:1px solid var(--primary);">
                        <div style="font-size:32px; margin-bottom:8px;">üèÜ</div>
                        <div style="font-weight:700; color:var(--primary);">Yutuq Ochildi!</div>
                        <div id="achievement-name" style="font-size:14px; margin-top:4px;"></div>
                    </div>
                    
                    <button class="btn-action" onclick="restartGame()">üîÑ QAYTA O'YNASH</button>
                    <button class="btn-action" style="background:var(--surface-light); margin-top:12px;" onclick="switchNav('home')">üè† ASOSIY SAHIFA</button>
                </div>
            </div>
        </div>

        <!-- GRAMMAR QUIZ SCREEN -->
        <div id="screen-grammar" class="screen">
            <div style="display:flex; align-items:center; gap:12px; margin-bottom:24px;">
                <button class="btn-option" style="width:auto; padding:8px 16px;" onclick="switchNav('quests')">
                    ‚óÄÔ∏è Orqaga
                </button>
                <h2 style="font-size:24px; font-weight:800;">üìñ Grammar Quiz</h2>
            </div>

            <div id="grammar-lobby">
                <div class="card">
                    <div style="text-align:center; margin-bottom:24px;">
                        <div style="font-size:48px; margin-bottom:16px;">üìù</div>
                        <h3 style="font-size:20px; font-weight:700;">Grammatik Maxlor</h3>
                        <p style="color:var(--text-dim); font-size:14px; margin-top:8px;"> Ingliz tili grammatikasini sinab ko'ring!</p>
                    </div>
                    
                    <div style="margin-bottom:24px;">
                        <p style="font-size:12px; color:var(--text-dim); margin-bottom:8px;">QIYINCHILIK:</p>
                        <div style="display:flex; gap:8px;">
                            <button class="btn-option active" id="grammar-diff-easy" onclick="selectGrammarDiff('easy')" style="flex:1; text-align:center;">üü¢ A1-A2</button>
                            <button class="btn-option" id="grammar-diff-medium" onclick="selectGrammarDiff('medium')" style="flex:1; text-align:center;">üü° B1-B2</button>
                            <button class="btn-option" id="grammar-diff-hard" onclick="selectGrammarDiff('hard')" style="flex:1; text-align:center;">üî¥ C1-C2</button>
                        </div>
                    </div>
                    
                    <button class="btn-action" onclick="startGrammarQuiz()">üöÄ BOSHLASH</button>
                </div>
            </div>

            <div id="grammar-play" style="display:none;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                    <span style="font-size:14px; color:var(--text-dim);">üìñ Grammar Quiz</span>
                    <span style="font-size:14px; font-weight:600;"><span id="grammar-question-num">1/10</span></span>
                </div>
                
                <div class="card" style="background:var(--surface-light);">
                    <div style="font-size:14px; color:var(--accent); margin-bottom:8px;">To'ldiring:</div>
                    <div style="font-size:20px; font-weight:600; margin-bottom:20px;" id="grammar-question">
                        "I ___ a student."
                    </div>
                    
                    <div class="options-grid" id="grammar-options">
                        <!-- Options injected here -->
                    </div>
                </div>
                
                <div style="margin-top:16px; display:flex; justify-content:space-between; font-size:14px;">
                    <span style="color:var(--text-dim);">üéØ XP: <span id="grammar-xp" style="color:var(--accent);">0</span></span>
                    <span style="color:var(--text-dim);">‚è±Ô∏è <span id="grammar-timer" style="color:white;">45</span>s</span>
                </div>
            </div>

            <div id="grammar-end" style="display:none;">
                <div class="card" style="text-align:center; padding:32px;">
                    <div style="font-size:64px; margin-bottom:16px;">üéì</div>
                    <h2 style="font-size:28px; font-weight:800; margin-bottom:8px;">Quiz Yakunlandi!</h2>
                    
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:16px; margin:24px 0;">
                        <div class="stat-box">
                            <div class="stat-value" id="grammar-end-score" style="color:var(--accent);">0</div>
                            <div class="stat-label">üí∞ XP</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="grammar-end-correct">0/10</div>
                            <div class="stat-label">‚úÖ To'g'ri</div>
                        </div>
                    </div>
                    
                    <div id="grammar-feedback" style="padding:16px; background:rgba(16,185,129,0.1); border-radius:12px; margin-bottom:24px;">
                        <div style="font-size:48px; margin-bottom:8px;">üéâ</div>
                        <div style="font-weight:700; color:var(--secondary);" id="grammar-feedback-text">Ajoyib natija!</div>
                    </div>
                    
                    <button class="btn-action" onclick="restartGrammar()">üîÑ QAYTA</button>
                    <button class="btn-action" style="background:var(--surface-light); margin-top:12px;" onclick="switchNav('quests')">‚óÄÔ∏è Orqaga</button>
                </div>
            </div>
        </div>
        <div id="screen-quests" class="screen">
            <h2 style="font-size:24px; font-weight:800; margin-bottom:24px;">Topshiriqlar</h2>

            <div class="card">
                <div class="quest-item">
                    <div class="quest-icon"><i data-lucide="message-square"></i></div>
                    <div class="quest-info">
                        <h4>AI bilan suhbat</h4>
                        <p>Ustoz bilan 5 daqiqa inglizcha gaplashing</p>
                    </div>
                </div>
                <button class="btn-action" style="background:var(--surface-light); box-shadow:none;"
                    onclick="botAction('ai_tutor')">
                    BOTGA O'TISH
                </button>
            </div>

            <div class="card">
                <div class="quest-item">
                    <div class="quest-icon" style="color:var(--secondary); background:rgba(16,185,129,0.1);"><i
                            data-lucide="book-open"></i></div>
                    <div class="quest-info">
                        <h4>Grammatika Master</h4>
                        <p>Grammatik testlarni ishlang</p>
                    </div>
                </div>
                <button class="btn-action" style="background:var(--surface-light); box-shadow:none;"
                    onclick="switchNav('grammar')">
                    üìñ GRAMMAR QUIZ
                </button>
            </div>
        </div>

        <!-- PROFILE -->
        <div id="screen-profile" class="screen">
            <div style="text-align:center; padding:20px 0;">
                <div
                    style="width:100px; height:100px; border-radius:50%; background:var(--gradient); margin:0 auto 16px; display:flex; align-items:center; justify-content:center; border:4px solid var(--surface-light);">
                    <i data-lucide="user" style="width:48px; height:48px; color:white;"></i>
                </div>
                <h2 id="user-name">Foydalanuvchi</h2>
                <p style="color:var(--text-dim); font-size:14px;" id="user-id">ID: ---</p>
                <button class="btn-action"
                    style="margin-top:16px; width:auto; padding:8px 16px; height:auto; background:var(--surface-light); box-shadow:none; font-size:12px;"
                    onclick="openEditProfile()">
                    <i data-lucide="edit-3" style="width:14px; height:14px;"></i>
                    PROFILNI TAHRIRLASH
                </button>
            </div>

            <div class="card">
                <h3 style="font-size:16px; font-weight:700; margin-bottom:16px;">Yutuqlar</h3>
                <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:12px;">
                    <div
                        style="aspect-ratio:1; border-radius:12px; background:var(--surface-light); display:flex; align-items:center; justify-content:center;">
                        <i data-lucide="zap" style="color:var(--accent);"></i>
                    </div>
                    <div
                        style="aspect-ratio:1; border-radius:12px; background:var(--surface-light); display:flex; align-items:center; justify-content:center;">
                        <i data-lucide="shield" style="color:var(--primary);"></i>
                    </div>
                    <div
                        style="aspect-ratio:1; border-radius:12px; background:var(--surface-light); display:flex; align-items:center; justify-content:center;">
                        <i data-lucide="star" style="color:var(--accent);"></i>
                    </div>
                    <div
                        style="aspect-ratio:1; border-radius:12px; background:var(--surface-light); display:flex; align-items:center; justify-content:center;">
                        <i data-lucide="flame" style="color:#ef4444;"></i>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- EDIT PROFILE MODAL -->
    <div id="modal-edit-profile" class="modal">
        <div class="modal-content">
            <h3 class="modal-title">Profilni tahrirlash</h3>
            <div class="input-group">
                <label>Ismingiz (Nickname)</label>
                <input type="text" id="edit-name" class="modal-input" placeholder="Ismingizni kiriting...">
            </div>
            <div class="modal-actions">
                <button class="btn-modal btn-cancel" onclick="closeModal('modal-edit-profile')">Bekor qilish</button>
                <button class="btn-modal btn-save" onclick="saveProfile()">Saqlash</button>
            </div>
        </div>
    </div>

    <!-- NAVIGATION -->
    <div class="bottom-nav">
        <div class="nav-item active" onclick="switchNav('home')">
            <i data-lucide="layout-grid"></i>
            <span>Markaz</span>
        </div>
        <div class="nav-item" onclick="switchNav('game')">
            <i data-lucide="swords"></i>
            <span>Jang</span>
        </div>
        <div class="nav-item" onclick="switchNav('quests')">
            <i data-lucide="scroll-text"></i>
            <span>Missiya</span>
        </div>
        <div class="nav-item" onclick="switchNav('profile')">
            <i data-lucide="user-circle"></i>
            <span>Profil</span>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.enableClosingConfirmation();
        lucide.createIcons();

        // Theme sync
        document.body.style.backgroundColor = tg.themeParams.bg_color || '#030712';

        // User Data
        const urlParams = new URLSearchParams(window.location.search);
        const urlName = urlParams.get('name');
        const user = tg.initDataUnsafe.user || { first_name: "O'quvchi", id: "555555" };
        document.getElementById('user-name').innerText = urlName || user.first_name;
        document.getElementById('user-id').innerText = "ID: " + user.id;

        // --- GAME LOGIC ---
        // Vocabulary Database with difficulty levels
        const VOCAB = {
            easy: [
                { "en": "Apple", "uz": "Olma" },
                { "en": "Book", "uz": "Kitob" },
                { "en": "Car", "uz": "Mashina" },
                { "en": "Dog", "uz": "It" },
                { "en": "Cat", "uz": "Mushuk" },
                { "en": "House", "uz": "Uy" },
                { "en": "Tree", "uz": "Daraxt" },
                { "en": "Water", "uz": "Suv" },
                { "en": "Bread", "uz": "Non" },
                { "en": "Milk", "uz": "Sut" },
                { "en": "Sun", "uz": "Quyosh" },
                { "en": "Moon", "uz": "Oy" },
                { "en": "Star", "uz": "Yulduz" },
                { "en": "Ball", "uz": "To'p" },
                { "en": "Door", "uz": "Eshik" },
                { "en": "Window", "uz": "Oyna" },
                { "en": "Hand", "uz": "Qo'l" },
                { "en": "Foot", "uz": "Oyoq" },
                { "en": "Eye", "uz": "Ko'z" },
                { "en": "Ear", "uz": "Quloq" }
            ],
            medium: [
                { "en": "Ability", "uz": "Qobiliyat" },
                { "en": "Accept", "uz": "Qabul qilmoq" },
                { "en": "Account", "uz": "Hisob" },
                { "en": "Action", "uz": "Harakat" },
                { "en": "Activity", "uz": "Faoliyat" },
                { "en": "Address", "uz": "Manzil" },
                { "en": "Advice", "uz": "Maslahat" },
                { "en": "Agency", "uz": "Agentlik" },
                { "en": "Agree", "uz": "Rozi bo'lmoq" },
                { "en": "Airport", "uz": "Aeroport" },
                { "en": "Answer", "uz": "Javob" },
                { "en": "Article", "uz": "Maqola" },
                { "en": "Artist", "uz": "Rassom" },
                { "en": "Attack", "uz": "Hujum" },
                { "en": "Author", "uz": "Muallif" },
                { "en": "Avoid", "uz": "O'zini olib qochmoq" },
                { "en": "Beautiful", "uz": "Chiroyli" },
                { "en": "Believe", "uz": "Ishonmoq" },
                { "en": "Become", "uz": "Bo'lmoq" },
                { "en": "Knowledge", "uz": "Bilim" }
            ],
            hard: [
                { "en": "Ambition", "uz": "Maqsad" },
                { "en": "Ancient", "uz": "Qadimiy" },
                { "en": "Anger", "uz": "G'azab" },
                { "en": "Argue", "uz": "Tortishmoq" },
                { "en": "Collaborate", "uz": "Hamkorlik qilmoq" },
                { "en": "Determine", "uz": "Aniqlamoq" },
                { "en": "Effort", "uz": "Harakat/G'ayrat" },
                { "en": "Flourish", "uz": "Gullab-yashnamoq" },
                { "en": "Gratitude", "uz": "Minnatdorchilik" },
                { "en": "Humble", "uz": "Kamtar" },
                { "en": "Innocent", "uz": "Aybsiz" },
                { "en": "Journey", "uz": "Sayohat" },
                { "en": "Loyal", "uz": "Sodiq" },
                { "en": "Magnificent", "uz": "Hashamatli" },
                { "en": "Narrative", "uz": "Hikoya qilish" },
                { "en": "Obvious", "uz": "Aniq/Ravshan" },
                { "en": "Patience", "uz": "Sabr-toqat" },
                { "en": "Magnificent", "uz": "Hashamatli" },
                { "en": "Perspective", "uz": "Nuqtai nazr" },
                { "en": "Principle", "uz": "Prinsip" }
            ]
        };

        // Achievements System
        const ACHIEVEMENTS = [
            { id: 'first_win', name: 'üéÆ Birinchi G‚Äòalaba', desc: 'Birinchi o‚Äòyin yutishi', icon: 'üéÆ', require: 1 },
            { id: 'streak_5', name: 'üî• 5 Streak', desc: '5 ta ketma-ket to‚Äòg‚Äòri javob', icon: 'üî•', require: 5 },
            { id: 'streak_10', name: 'üí• 10 Streak', desc: '10 ta ketma-ket to‚Äòg‚Äòri javob', icon: 'üí•', require: 10 },
            { id: 'streak_20', name: '‚ö° 20 Streak', desc: '20 ta ketma-ket to‚Äòg‚Äòri javob', icon: '‚ö°', require: 20 },
            { id: 'score_100', name: 'üí∞ 100 XP', desc: 'Bir o‚Äòyinda 100 XP yig‚Äòish', icon: 'üí∞', require: 100 },
            { id: 'score_200', name: 'üíé 200 XP', desc: 'Bir o‚Äòyinda 200 XP yig‚Äòish', icon: 'üíé', require: 200 },
            { id: 'combo_3', name: '‚≠ê 3x Combo', desc: '3x combo yig‚Äòish', icon: '‚≠ê', require: 3 },
            { id: 'combo_5', name: 'üåü 5x Combo', desc: '5x combo yig‚Äòish', icon: 'üåü', require: 5 },
            { id: 'accuracy_100', name: 'üéØ 100% Aniqlik', desc: 'Hech qanday xato bo‚Äòlmagan o‚Äòyin', icon: 'üéØ', require: 100 },
            { id: 'games_10', name: 'üèÜ 10 O‚Äòyin', desc: '10 ta o‚Äòyin o‚Äòynash', icon: 'üèÜ', require: 10 }
        ];

        // Game State
        let gameState = {
            mode: 'classic',
            difficulty: 'easy',
            xp: 0,
            score: 0,
            streak: 0,
            maxStreak: 0,
            combo: 1,
            maxCombo: 1,
            correct: 0,
            wrong: 0,
            totalQuestions: 0,
            timeLeft: 60,
            timerId: null,
            questionsAnswered: 0,
            questionsTotal: 10,
            unlockedAchievements: []
        };

        // Mode Descriptions
        const MODE_DESCS = {
            classic: 'To‚Äòg‚Äòri javobni tanlang!',
            speed: 'Tez-tez javob ber!',
            flash: 'Flash Mode: 30 soniya!'
        };

        // Difficulty Settings
        const DIFFICULTY_SETTINGS = {
            easy: { time: 60, xpBonus: 1, questionCount: 10 },
            medium: { time: 45, xpBonus: 2, questionCount: 15 },
            hard: { time: 30, xpBonus: 3, questionCount: 20 }
        };

        // Sound Effects (using Web Audio API)
        const sounds = {
            correct: null,
            wrong: null,
            combo: null,
            achievement: null
        };

        function initSounds() {
            // Create simple beep sounds using Web Audio API
            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (AudioContext) {
                    sounds.correct = () => playTone(800, 'sine', 0.1);
                    sounds.wrong = () => playTone(200, 'sawtooth', 0.3);
                    sounds.combo = () => { playTone(600, 'sine', 0.1); setTimeout(() => playTone(800, 'sine', 0.1), 100); };
                    sounds.achievement = () => { 
                        playTone(523, 'sine', 0.15); 
                        setTimeout(() => playTone(659, 'sine', 0.15), 150);
                        setTimeout(() => playTone(784, 'sine', 0.2), 300);
                    };
                }
            } catch(e) {
                console.log('Audio not supported');
            }
        }

        function playTone(freq, type, duration) {
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.type = type;
                osc.frequency.value = freq;
                gain.gain.setValueAtTime(0.3, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + duration);
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.start();
                osc.stop(ctx.currentTime + duration);
            } catch(e) {}
        }

        function selectMode(mode) {
            gameState.mode = mode;
            document.querySelectorAll('#game-modes .btn-option').forEach(b => b.classList.remove('active'));
            document.getElementById('mode-' + mode).classList.add('active');
            document.getElementById('mode-desc').innerText = MODE_DESCS[mode];
            tg.HapticFeedback.selectionChanged();
        }

        function selectDifficulty(diff) {
            gameState.difficulty = diff;
            document.querySelectorAll('#game-difficulty .btn-option').forEach(b => b.classList.remove('active'));
            document.getElementById('diff-' + diff).classList.add('active');
            tg.HapticFeedback.selectionChanged();
        }

        function startGame() {
            const settings = DIFFICULTY_SETTINGS[gameState.difficulty];
            
            // Reset state
            gameState.xp = 0;
            gameState.score = 0;
            gameState.streak = 0;
            gameState.maxStreak = 0;
            gameState.combo = 1;
            gameState.maxCombo = 1;
            gameState.correct = 0;
            gameState.wrong = 0;
            gameState.totalQuestions = 0;
            gameState.questionsAnswered = 0;
            gameState.questionsTotal = settings.questionCount;
            gameState.timeLeft = gameState.mode === 'flash' ? 30 : settings.time;
            
            document.getElementById('game-lobby').style.display = 'none';
            document.getElementById('game-end').style.display = 'none';
            document.getElementById('game-play').style.display = 'block';
            
            updateGameUI();
            startTimer();
            nextRound();
        }

        function startTimer() {
            clearInterval(gameState.timerId);
            gameState.timerId = setInterval(() => {
                gameState.timeLeft--;
                document.getElementById('game-timer').innerText = gameState.timeLeft;
                
                // Warning color when low time
                if (gameState.timeLeft <= 10) {
                    document.getElementById('game-timer').style.color = '#ef4444';
                    document.getElementById('game-timer').style.animation = 'pulse 0.5s infinite';
                }
                
                if (gameState.timeLeft <= 0) endGame();
            }, 1000);
        }

        function updateGameUI() {
            document.getElementById('game-xp').innerText = `+${gameState.xp} XP`;
            document.getElementById('game-streak').innerText = gameState.streak;
            document.getElementById('game-combo').innerText = `x${gameState.combo}`;
            document.getElementById('game-score').innerText = gameState.score;
            document.getElementById('question-num').innerText = `${gameState.questionsAnswered}/${gameState.questionsTotal}`;
        }

        function getRandomVocab(difficulty) {
            const vocab = VOCAB[difficulty] || VOCAB.easy;
            return vocab[Math.floor(Math.random() * vocab.length)];
        }

        function nextRound() {
            if (gameState.questionsAnswered >= gameState.questionsTotal) {
                endGame();
                return;
            }
            
            const current = getRandomVocab(gameState.difficulty);
            document.getElementById('current-word').innerText = current.en;

            const options = [current.uz];
            const allVocab = [...(VOCAB.easy || []), ...(VOCAB.medium || []), ...(VOCAB.hard || [])];
            while (options.length < 4) {
                const r = allVocab[Math.floor(Math.random() * allVocab.length)].uz;
                if (!options.includes(r)) options.push(r);
            }
            options.sort(() => Math.random() - 0.5);

            const grid = document.getElementById('game-options');
            grid.innerHTML = '';
            options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'btn-option';
                btn.innerHTML = `${opt} <i data-lucide="chevron-right" style="width:16px;"></i>`;
                btn.onclick = () => checkAnswer(opt, current.uz, btn);
                grid.appendChild(btn);
            });
            lucide.createIcons();
            
            gameState.questionsAnswered++;
            updateGameUI();
        }

        function checkAnswer(selected, correct, btn) {
            if (selected === correct) {
                // Correct Answer
                btn.classList.add('correct');
                tg.HapticFeedback.notificationOccurred('success');
                if (sounds.correct) sounds.correct();
                
                gameState.correct++;
                gameState.streak++;
                gameState.maxStreak = Math.max(gameState.maxStreak, gameState.streak);
                
                // Combo system
                if (gameState.streak >= 3) {
                    gameState.combo = Math.min(5, Math.floor(gameState.streak / 3) + 1);
                    gameState.maxCombo = Math.max(gameState.maxCombo, gameState.combo);
                    showCombo(gameState.combo);
                    if (sounds.combo) sounds.combo();
                }
                
                // Calculate XP
                const settings = DIFFICULTY_SETTINGS[gameState.difficulty];
                const baseXP = 10;
                const comboBonus = gameState.combo > 1 ? (gameState.combo - 1) * 5 : 0;
                const xpEarned = (baseXP + comboBonus) * settings.xpBonus;
                gameState.xp += xpEarned;
                gameState.score += xpEarned;
                
                // Show score popup
                showScorePopup(`+${xpEarned}`);
                
                updateGameUI();
                setTimeout(nextRound, 500);
            } else {
                // Wrong Answer
                btn.classList.add('wrong');
                tg.HapticFeedback.notificationOccurred('error');
                if (sounds.wrong) sounds.wrong();
                
                gameState.wrong++;
                gameState.streak = 0;
                gameState.combo = 1;
                
                // Highlight correct answer
                document.querySelectorAll('.btn-option').forEach(b => {
                    if (b.innerText.includes(correct)) {
                        b.classList.add('correct');
                    }
                });
                
                updateGameUI();
                setTimeout(nextRound, 800);
            }
        }

        function showScorePopup(text) {
            const popup = document.createElement('div');
            popup.className = 'score-popup';
            popup.innerText = text;
            document.body.appendChild(popup);
            setTimeout(() => popup.remove(), 1000);
        }

        function showCombo(combo) {
            const display = document.getElementById('combo-display');
            display.innerText = `${combo}x COMBO!`;
            display.classList.add('active');
            setTimeout(() => display.classList.remove('active'), 800);
        }

        function endGame() {
            clearInterval(gameState.timerId);
            tg.HapticFeedback.impactOccurred('heavy');
            
            // Calculate accuracy
            const total = gameState.correct + gameState.wrong;
            const accuracy = total > 0 ? Math.round((gameState.correct / total) * 100) : 0;
            
            // Check achievements
            const newAchievements = checkAchievements(accuracy);
            
            // Update end screen
            document.getElementById('game-play').style.display = 'none';
            document.getElementById('game-end').style.display = 'block';
            
            document.getElementById('end-score').innerText = gameState.xp;
            document.getElementById('end-accuracy').innerText = `${accuracy}%`;
            document.getElementById('end-streak').innerText = gameState.maxStreak;
            
            // Determine rank
            let rank = 'ü•â Bronze';
            if (gameState.xp >= 200) rank = 'ü•à Silver';
            if (gameState.xp >= 300) rank = 'ü•á Gold';
            if (gameState.xp >= 500) rank = 'üíé Diamond';
            if (gameState.xp >= 1000) rank = 'üëë Legend';
            document.getElementById('end-level').innerText = rank;
            
            // Show achievement if unlocked
            const achDisplay = document.getElementById('achievement-unlock');
            if (newAchievements.length > 0) {
                achDisplay.style.display = 'block';
                document.getElementById('achievement-name').innerText = newAchievements[0].name;
                if (sounds.achievement) sounds.achievement();
            } else {
                achDisplay.style.display = 'none';
            }
            
            // Send data to bot
            tg.sendData(JSON.stringify({
                action: "game_end",
                xp: gameState.xp,
                score: gameState.score,
                accuracy: accuracy,
                streak: gameState.maxStreak,
                achievements: newAchievements.map(a => a.id)
            }));
        }

        function checkAchievements(accuracy) {
            const newUnlocked = [];
            
            // Check each achievement
            ACHIEVEMENTS.forEach(ach => {
                let unlocked = false;
                
                switch(ach.id) {
                    case 'first_win':
                        unlocked = gameState.correct + gameState.wrong > 0;
                        break;
                    case 'streak_5':
                        unlocked = gameState.maxStreak >= 5;
                        break;
                    case 'streak_10':
                        unlocked = gameState.maxStreak >= 10;
                        break;
                    case 'streak_20':
                        unlocked = gameState.maxStreak >= 20;
                        break;
                    case 'score_100':
                        unlocked = gameState.xp >= 100;
                        break;
                    case 'score_200':
                        unlocked = gameState.xp >= 200;
                        break;
                    case 'combo_3':
                        unlocked = gameState.maxCombo >= 3;
                        break;
                    case 'combo_5':
                        unlocked = gameState.maxCombo >= 5;
                        break;
                    case 'accuracy_100':
                        unlocked = accuracy === 100 && gameState.totalQuestions >= 5;
                        break;
                }
                
                if (unlocked && !gameState.unlockedAchievements.includes(ach.id)) {
                    newUnlocked.push(ach);
                    gameState.unlockedAchievements.push(ach.id);
                }
            });
            
            return newUnlocked;
        }

        function restartGame() {
            document.getElementById('game-end').style.display = 'none';
            document.getElementById('game-lobby').style.display = 'block';
            document.getElementById('game-timer').style.color = 'white';
            document.getElementById('game-timer').style.animation = 'none';
            tg.HapticFeedback.selectionChanged();
        }

        // Initialize sounds on first interaction
        document.addEventListener('click', () => {
            if (!sounds.correct) initSounds();
        }, { once: true });

        // --- GRAMMAR QUIZ ---
        const GRAMMAR_QUESTIONS = {
            easy: [
                { q: "I ___ a student.", o: ["am", "is", "are", "be"], a: "am" },
                { q: "She ___ TV every day.", o: ["watch", "watches", "watching", "watched"], a: "watches" },
                { q: "They ___ to school yesterday.", o: ["go", "goes", "went", "going"], a: "went" },
                { q: "He ___ a book now.", o: ["read", "reads", "reading", "readed"], a: "reading" },
                { q: "We ___ English every day.", o: ["study", "studies", "studying", "studied"], a: "study" },
                { q: "She ___ to the store yesterday.", o: ["go", "goes", "went", "gone"], a: "went" },
                { q: "I ___ my homework.", o: ["do", "does", "did", "doing"], a: "do" },
                { q: "The cat ___ on the bed.", o: ["sleep", "sleeps", "sleeping", "slept"], a: "sleeps" }
            ],
            medium: [
                { q: "Where ___ you go yesterday?", o: ["do", "does", "did", "done"], a: "did" },
                { q: "I have ___ to London twice.", o: ["go", "went", "gone", "been"], a: "been" },
                { q: "If I ___ a million dollars, I would buy a car.", o: ["have", "had", "has", "will have"], a: "had" },
                { q: "I wish I ___ more time.", o: ["have", "has", "had", "having"], a: "had" },
                { q: "By next year, I ___ my degree.", o: ["finish", "will finish", "will have finished", "finished"], a: "will have finished" },
                { q: "She ___ for 2 hours.", o: ["is sleeping", "has been sleeping", "slept", "sleeps"], a: "has been sleeping" },
                { q: "The movie ___ by the time we arrived.", o: ["started", "had started", "has started", "was starting"], a: "had started" },
                { q: "If he ___ here, he would help us.", o: ["was", "is", "were", "had been"], a: "were" }
            ],
            hard: [
                { q: "Hardly ___ I entered the room when it started raining.", o: ["had", "did", "was", "have"], a: "had" },
                { q: "It is essential that he ___ here.", o: ["is", "be", "was", "were"], a: "be" },
                { q: "He is second to ___ in mathematics.", o: ["none", "no one", "nobody", "nothing"], a: "none" },
                { q: "Not only ___ the work, but he also finished early.", o: ["he did", "did he", "he finished", "finished he"], a: "did he" },
                { q: "Were it not for his help, I ___ the work.", o: ["would fail", "will fail", "would have failed", "fail"], a: "would have failed" },
                { q: "She is the only one ___ the answer.", o: ["who knows", "knows", "who know", "knowing"], a: "who knows" },
                { q: "I look forward to ___ from you soon.", o: ["hear", "hearing", "heard", "have heard"], a: "hearing" },
                { q: "But for the rain, we ___ earlier.", o: ["would arrive", "will arrive", "would have arrived", "arrive"], a: "would have arrived" }
            ]
        };

        let grammarState = {
            difficulty: 'easy',
            xp: 0,
            correct: 0,
            wrong: 0,
            timeLeft: 45,
            timerId: null,
            questionsAnswered: 0,
            questionsTotal: 10
        };

        function selectGrammarDiff(diff) {
            grammarState.difficulty = diff;
            document.querySelectorAll('#grammar-difficulty .btn-option').forEach(b => b.classList.remove('active'));
            document.getElementById('grammar-diff-' + diff).classList.add('active');
            tg.HapticFeedback.selectionChanged();
        }

        function startGrammarQuiz() {
            // Reset state
            grammarState.xp = 0;
            grammarState.correct = 0;
            grammarState.wrong = 0;
            grammarState.questionsAnswered = 0;
            grammarState.timeLeft = grammarState.difficulty === 'easy' ? 60 : grammarState.difficulty === 'medium' ? 45 : 30;
            
            document.getElementById('grammar-lobby').style.display = 'none';
            document.getElementById('grammar-end').style.display = 'none';
            document.getElementById('grammar-play').style.display = 'block';
            
            document.getElementById('grammar-xp').innerText = '0';
            startGrammarTimer();
            nextGrammarQuestion();
        }

        function startGrammarTimer() {
            clearInterval(grammarState.timerId);
            document.getElementById('grammar-timer').innerText = grammarState.timeLeft;
            grammarState.timerId = setInterval(() => {
                grammarState.timeLeft--;
                document.getElementById('grammar-timer').innerText = grammarState.timeLeft;
                if (grammarState.timeLeft <= 0) endGrammarQuiz();
            }, 1000);
        }

        function nextGrammarQuestion() {
            if (grammarState.questionsAnswered >= grammarState.questionsTotal) {
                endGrammarQuiz();
                return;
            }
            
            const questions = GRAMMAR_QUESTIONS[grammarState.difficulty] || GRAMMAR_QUESTIONS.easy;
            const current = questions[Math.floor(Math.random() * questions.length)];
            
            document.getElementById('grammar-question').innerText = `"${current.q}"`;
            document.getElementById('grammar-question-num').innerText = `${grammarState.questionsAnswered + 1}/${grammarState.questionsTotal}`;
            
            const grid = document.getElementById('grammar-options');
            grid.innerHTML = '';
            
            current.o.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'btn-option';
                btn.innerHTML = `${opt}`;
                btn.onclick = () => checkGrammarAnswer(opt, current.a, btn);
                grid.appendChild(btn);
            });
            
            grammarState.questionsAnswered++;
        }

        function checkGrammarAnswer(selected, correct, btn) {
            clearInterval(grammarState.timerId);
            
            if (selected === correct) {
                btn.classList.add('correct');
                tg.HapticFeedback.notificationOccurred('success');
                if (sounds.correct) sounds.correct();
                
                grammarState.correct++;
                const xpEarned = 15;
                grammarState.xp += xpEarned;
                document.getElementById('grammar-xp').innerText = grammarState.xp;
                
                setTimeout(() => {
                    startGrammarTimer();
                    nextGrammarQuestion();
                }, 800);
            } else {
                btn.classList.add('wrong');
                tg.HapticFeedback.notificationOccurred('error');
                if (sounds.wrong) sounds.wrong();
                
                grammarState.wrong++;
                
                // Highlight correct answer
                document.querySelectorAll('#grammar-options .btn-option').forEach(b => {
                    if (b.innerText === correct) {
                        b.classList.add('correct');
                    }
                });
                
                setTimeout(() => {
                    startGrammarTimer();
                    nextGrammarQuestion();
                }, 1200);
            }
        }

        function endGrammarQuiz() {
            clearInterval(grammarState.timerId);
            tg.HapticFeedback.impactOccurred('heavy');
            
            document.getElementById('grammar-play').style.display = 'none';
            document.getElementById('grammar-end').style.display = 'block';
            
            document.getElementById('grammar-end-score').innerText = grammarState.xp;
            document.getElementById('grammar-end-correct').innerText = `${grammarState.correct}/${grammarState.questionsTotal}`;
            
            const feedbackEl = document.getElementById('grammar-feedback');
            const feedbackText = document.getElementById('grammar-feedback-text');
            const percentage = (grammarState.correct / grammarState.questionsTotal) * 100;
            
            if (percentage >= 90) {
                feedbackEl.style.background = 'rgba(16, 185, 129, 0.2)';
                feedbackText.innerText = 'üéâ Ajoyib! Siz grammatika dahosi! ';
            } else if (percentage >= 70) {
                feedbackEl.style.background = 'rgba(139, 92, 246, 0.2)';
                feedbackText.innerText = 'üëç Yaxshi natija! Davom eting! ';
            } else if (percentage >= 50) {
                feedbackEl.style.background = 'rgba(245, 158, 11, 0.2)';
                feedbackText.innerText = 'üìö Yaxshilanish kerak! ';
            } else {
                feedbackEl.style.background = 'rgba(239, 68, 68, 0.2)';
                feedbackText.innerText = "üí™ Kopiroq mashq qiling!";
            }
            
            // Send data to bot
            tg.sendData(JSON.stringify({
                action: "grammar_end",
                xp: grammarState.xp,
                correct: grammarState.correct,
                total: grammarState.questionsTotal
            }));
        }

        function restartGrammar() {
            document.getElementById('grammar-end').style.display = 'none';
            document.getElementById('grammar-lobby').style.display = 'block';
            tg.HapticFeedback.selectionChanged();
        }

        // Initialize date for daily challenges
        const today = new Date();
        const options = { day: 'numeric', month: 'short' };
        document.getElementById('today-date') && (document.getElementById('today-date').innerText = today.toLocaleDateString('uz-UZ', options));

        // Daily Challenge System
        const DAILY_CHALLENGES = [
            { id: 'play_3', name: "3 ta o'yin o'ynang", target: 3, xp: 500, icon: 'üéÆ' },
            { id: 'streak_5', name: "5 ta ketma-ket to'g'ri javob", target: 5, xp: 300, icon: 'üî•' },
            { id: 'grammar_5', name: "5 ta grammatik savol", target: 5, xp: 400, icon: 'üìù' },
            { id: 'xp_100', name: "100 XP yig'ing", target: 100, xp: 300, icon: 'üí∞' }
        ];

        let dailyProgress = { plays: 0, streak: 0, grammar: 0, xp: 0 };

        function updateDailyChallenges() {
            const challenge = DAILY_CHALLENGES[0]; // Use first challenge for demo
            const progress = Math.min(dailyProgress.plays, challenge.target);
            const percentage = Math.round((progress / challenge.target) * 100);
            
            document.getElementById('daily-progress') && (document.getElementById('daily-progress').innerText = `${progress}/${challenge.target}`);
            document.getElementById('daily-progress-bar') && (document.getElementById('daily-progress-bar').style.width = `${percentage}%`);
            
            // Update time remaining
            const hoursLeft = 24 - today.getHours();
            document.getElementById('daily-time') && (document.getElementById('daily-time').innerText = `${hoursLeft} soat`);
        }

        // Initialize daily challenges
        updateDailyChallenges();

        // --- NAVIGATION ---
        function switchNav(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('screen-' + screenId).classList.add('active');

            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            const items = document.querySelectorAll('.nav-item');
            if (screenId === 'home') items[0].classList.add('active');
            if (screenId === 'game') items[1].classList.add('active');
            if (screenId === 'quests') items[2].classList.add('active');
            if (screenId === 'profile') items[3].classList.add('active');

            tg.HapticFeedback.selectionChanged();
        }

        // --- BOT INTEGRATION ---
        function botAction(action) {
            // Sends data back to the bot
            tg.sendData(JSON.stringify({ action: action }));
            tg.close();
        }

        // --- PROFILE EDITING ---
        function openEditProfile() {
            document.getElementById('edit-name').value = document.getElementById('user-name').innerText;
            document.getElementById('modal-edit-profile').classList.add('active');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        function saveProfile() {
            const newName = document.getElementById('edit-name').value.trim();
            if (!newName) {
                tg.showAlert("Ism bo'sh bo'lishi mumkin emas!");
                return;
            }

            // Update UI locally
            document.getElementById('user-name').innerText = newName;

            // Send to bot to save
            tg.sendData(JSON.stringify({
                action: "update_profile",
                name: newName
            }));

            closeModal('modal-edit-profile');
            tg.HapticFeedback.notificationOccurred('success');
        }

    </script>
</body>

</html>